---
import Layout from "../layouts/Layout.astro";
import BeforeAfter from "../components/BeforeAfter.astro";
import Products from "../components/Products.astro";
import StackedCards from "../components/StackedCards.astro";
import Footer from "../components/Footer.astro";

// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout>
  <nav class="progress-nav">
    <div class="progress-nav__inner">
      <a href="#top" class="progress-nav__logo">JJ'S</a>
      <div class="progress-nav__wrapper">
        <div data-progress-nav-list="" class="progress-nav__list">
          <div class="progress-nav__indicator"></div>
          <div
            data-progress-nav-target="#top"
            class="progress-nav__btn is--before"
          >
          </div>
          <a
            data-progress-nav-target="#introduction"
            href="#introduction"
            class="progress-nav__btn"
            ><span class="progress-nav__btn-text">1. About</span><span
              class="progress-nav__btn-text is--duplicate">1. About</span
            ></a
          >
          <a
            data-progress-nav-target="#concept"
            href="#concept"
            class="progress-nav__btn"
            ><span class="progress-nav__btn-text">2. Services</span><span
              class="progress-nav__btn-text is--duplicate">2. Servies</span
            ></a
          >
          <a
            data-progress-nav-target="#product"
            href="#product"
            class="progress-nav__btn"
            ><span class="progress-nav__btn-text">3. Book</span><span
              class="progress-nav__btn-text is--duplicate">3. Book</span
            ></a
          >
          <div
            data-progress-nav-target="#bottom"
            class="progress-nav__btn is--after"
          >
          </div>
        </div>
      </div>
      <a href="#bottom" class="progress-nav__contact-btn"
        ><span class="progress-nav__btn-text">Book</span><span
          class="progress-nav__btn-text is--duplicate">Book</span
        ></a
      >
    </div>
  </nav>
  <section id="top" data-progress-nav-anchor="" class="section-resource">
    <h2 class="section-resource__h2" data-split="heading">JJ'S DETAILING</h2>
    <h3 class="section-resource__h3" data-split="heading">
      Meticulous Detailing. Stunning Results.
    </h3>
    <BeforeAfter />
  </section>
  <section
    id="introduction"
    data-progress-nav-anchor=""
    class="section-resource is--flipped"
  >
    <h2
      class="section-resource__h2 section-resouce__h2--white"
      data-split="heading"
    >
      About Us
    </h2>
    <div class="about-section">
      <div class="about-section__text-container">
        <p data-highlight-text>
          Located in Abbotsford, British Columbia, JJ's Detailing strives to
          clean, restore, and protect your vehicle. Jo, the founder of JJ's
          Detailing, is an experienced automotive detailer that loves to see the
          face of happy customers after their vehicle has been returned to it's
          former glory!
        </p>
      </div>
      <StackedCards />
    </div>
  </section>
  <section id="concept" data-progress-nav-anchor="" class="section-resource">
    <h2 class="section-resource__h2" data-split="heading">Services</h2>
    <Products />
  </section>
  <section
    id="product"
    data-progress-nav-anchor=""
    class="section-resource is--flipped"
  >
    <h2 class="section-resource__h2" data-split="heading">Book</h2>
  </section>
  <Footer
    id="bottom"
    data-progress-nav-anchor=""
    class="section-resource is--flipped"
  />
</Layout>

<script>
  import gsap from "gsap";
  import SplitText from "gsap/SplitText";
  import ScrollTrigger from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  let headings = document.querySelectorAll('[data-split="heading"]');
  headings.forEach((heading) => {
    SplitText.create(heading, {
      type: "lines",
      autoSplit: true,
      mask: "lines",
      onSplit(instance) {
        instance.lines.forEach((line) => {
          line.style.textAlign = "center";
        });
        return gsap.from(instance.lines, {
          duration: 1.5,
          yPercent: 110,
          stagger: 0.1,
          ease: "expo.out",
          scrollTrigger: {
            trigger: heading,
            start: "top 80%",
            toggleActions: "play reverse play reverse",
          },
        });
      },
    });
  });

  function initGlobalParallax() {
    const mm = gsap.matchMedia();

    mm.add(
      {
        isMobile: "(max-width:479px)",
        isMobileLandscape: "(max-width:767px)",
        isTablet: "(max-width:991px)",
        isDesktop: "(min-width:992px)",
      },
      (context) => {
        const {
          isMobile = false,
          isMobileLandscape = false,
          isTablet = false,
        } = context?.conditions ?? {};

        const ctx = gsap.context(() => {
          document
            .querySelectorAll('[data-parallax="trigger"]')
            .forEach((trigger) => {
              // Check if this trigger has to be disabled on smaller breakpoints
              const disable = trigger.getAttribute("data-parallax-disable");
              if (
                (disable === "mobile" && isMobile) ||
                (disable === "mobileLandscape" && isMobileLandscape) ||
                (disable === "tablet" && isTablet)
              ) {
                return;
              }

              // Optional: you can target an element inside a trigger if necessary
              const target =
                trigger.querySelector('[data-parallax="target"]') || trigger;

              // Get the direction value to decide between xPercent or yPercent tween
              const direction =
                trigger.getAttribute("data-parallax-direction") || "vertical";
              const prop = direction === "horizontal" ? "xPercent" : "yPercent";

              // Get the scrub value, our default is 'true' because that feels nice with Lenis
              const scrubAttr = trigger.getAttribute("data-parallax-scrub");
              const scrub = scrubAttr ? parseFloat(scrubAttr) : true;

              // Get the start position in %
              const startAttr = trigger.getAttribute("data-parallax-start");
              const startVal = startAttr !== null ? parseFloat(startAttr) : 20;

              // Get the end position in %
              const endAttr = trigger.getAttribute("data-parallax-end");
              const endVal = endAttr !== null ? parseFloat(endAttr) : -20;

              // Get the start value of the ScrollTrigger
              const scrollStartRaw =
                trigger.getAttribute("data-parallax-scroll-start") ||
                "top bottom";
              const scrollStart = `clamp(${scrollStartRaw})`;

              // Get the end value of the ScrollTrigger
              const scrollEndRaw =
                trigger.getAttribute("data-parallax-scroll-end") ||
                "bottom top";
              const scrollEnd = `clamp(${scrollEndRaw})`;

              gsap.fromTo(
                target,
                { [prop]: startVal },
                {
                  [prop]: endVal,
                  ease: "none",
                  scrollTrigger: {
                    trigger,
                    start: scrollStart,
                    end: scrollEnd,
                    scrub,
                  },
                }
              );
            });
        });

        return () => ctx.revert();
      }
    );
  }
  function initProgressNavigation() {
    // Cache the parent container
    let navProgress = document.querySelector("[data-progress-nav-list]");

    // Create or select the moving indicator
    let indicator = navProgress.querySelector(".progress-nav__indicator");
    if (!indicator) {
      indicator = document.createElement("div");
      indicator.className = "progress-nav__indicator";
      navProgress.appendChild(indicator);
    }

    // Function to update the indicator based on the active nav link
    function updateIndicator(activeLink) {
      let parentWidth = navProgress.offsetWidth;
      let parentHeight = navProgress.offsetHeight;

      // Get the active link's position relative to the parent
      let parentRect = navProgress.getBoundingClientRect();
      let linkRect = activeLink.getBoundingClientRect();
      let linkPos = {
        left: linkRect.left - parentRect.left,
        top: linkRect.top - parentRect.top,
      };

      let linkWidth = activeLink.offsetWidth;
      let linkHeight = activeLink.offsetHeight;

      // Calculate percentage values relative to parent dimensions
      let leftPercent = (linkPos.left / parentWidth) * 100;
      let topPercent = (linkPos.top / parentHeight) * 100;
      let widthPercent = (linkWidth / parentWidth) * 100;
      let heightPercent = (linkHeight / parentHeight) * 100;

      // Update the indicator with a smooth CSS transition (set in your CSS)
      indicator.style.left = leftPercent + "%";
      indicator.style.top = topPercent + "%";
      indicator.style.width = widthPercent + "%";
      indicator.style.height = heightPercent + "%";
    }

    // Get all anchor sections
    let progressAnchors = gsap.utils.toArray("[data-progress-nav-anchor]");

    progressAnchors.forEach((progressAnchor) => {
      let anchorID = progressAnchor.getAttribute("id");

      ScrollTrigger.create({
        trigger: progressAnchor,
        start: "0% 50%",
        end: "100% 50%",
        onEnter: () => {
          let activeLink = navProgress.querySelector(
            '[data-progress-nav-target="#' + anchorID + '"]'
          );
          activeLink.classList.add("is--active");
          // Remove 'is--active' class from sibling links
          let siblings = navProgress.querySelectorAll(
            "[data-progress-nav-target]"
          );
          siblings.forEach((sib) => {
            if (sib !== activeLink) {
              sib.classList.remove("is--active");
            }
          });
          updateIndicator(activeLink);
        },
        onEnterBack: () => {
          let activeLink = navProgress.querySelector(
            '[data-progress-nav-target="#' + anchorID + '"]'
          );
          activeLink.classList.add("is--active");
          // Remove 'is--active' class from sibling links
          let siblings = navProgress.querySelectorAll(
            "[data-progress-nav-target]"
          );
          siblings.forEach((sib) => {
            if (sib !== activeLink) {
              sib.classList.remove("is--active");
            }
          });
          updateIndicator(activeLink);
        },
      });
    });
  }

  function initHighlightText() {
    let splitHeadingTargets = document.querySelectorAll(
      "[data-highlight-text]"
    );
    splitHeadingTargets.forEach((heading) => {
      const scrollStart =
        heading.getAttribute("data-highlight-scroll-start") || "top 90%";
      const scrollEnd =
        heading.getAttribute("data-highlight-scroll-end") || "center 40%";
      const fadedValue = heading.getAttribute("data-highlight-fade") || 0.2; // Opacity of letter
      const staggerValue =
        heading.getAttribute("data-highlight-stagger") || 0.1; // Smoother reveal

      new SplitText(heading, {
        type: "words, chars",
        autoSplit: true,
        onSplit(self) {
          let ctx = gsap.context(() => {
            let tl = gsap.timeline({
              scrollTrigger: {
                scrub: true,
                trigger: heading,
                start: scrollStart,
                end: scrollEnd,
              },
            });
            tl.from(self.chars, {
              autoAlpha: fadedValue,
              stagger: staggerValue,
              ease: "linear",
            });
          });
          return ctx; // return our animations so GSAP can clean them up when onSplit fires
        },
      });
    });
  }

  // Initialize Highlight Text on Scroll
  document.addEventListener("DOMContentLoaded", () => {
    initHighlightText();
  });

  // Initialize One Page Progress Navigation

  initProgressNavigation();

  // Initialize Global Parallax Setup

  initGlobalParallax();
</script>

<style>
  .progress-nav {
    width: 100%;
    padding: 2em;
    position: fixed;
    top: 0;
    left: 0;
    box-sizing: border-box;
    z-index: 9999;
  }

  .progress-nav__inner {
    justify-content: space-between;
    align-items: center;
    display: flex;
    position: relative;
  }

  .progress-nav__logo {
    color: inherit;
    text-decoration: none;
    color: #f25042;
    font-family: "futura-100", sans-serif;
    font-weight: 700;
    font-style: normal;
    font-size: 2rem;
  }

  .progress-nav__logo-svg {
    width: 8em;
  }

  .progress-nav__wrapper {
    background-color: #f25042;
    border-radius: 50em;
    padding: 0.5em;
    z-index: 1000;
  }

  .progress-nav__list {
    border-radius: 50em;
    justify-content: flex-start;
    align-items: center;
    display: flex;
    position: relative;
    overflow: hidden;
  }

  .progress-nav__indicator {
    z-index: 2;
    background-color: #fafafa;
    border-radius: 50em;
    width: 2.5em;
    height: 2.5em;
    position: absolute;
    left: -2.5em;
    transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .progress-nav__btn {
    z-index: 3;
    cursor: pointer;
    color: inherit;
    justify-content: center;
    align-items: center;
    height: 2.5em;
    padding-left: 1em;
    padding-right: 1em;
    text-decoration: none;
    display: flex;
    position: relative;
    overflow: hidden;
  }

  .progress-nav__btn.is--before {
    z-index: 1;
    width: 2.5em;
    height: 2.5em;
    padding-left: 0;
    padding-right: 0;
    position: absolute;
    right: 100%;
  }

  .progress-nav__btn.is--after {
    z-index: 1;
    width: 2.5em;
    height: 2.5em;
    padding-left: 0;
    padding-right: 0;
    position: absolute;
    left: 100%;
  }

  .progress-nav__btn-text {
    white-space: nowrap;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-size: 1.125em;
    font-weight: 500;
    display: flex;
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    transform: translateY(0%) rotate(0.001deg);
    font-family: "futura-100", sans-serif;
    font-weight: 400;
    font-style: normal;
  }

  .progress-nav__btn-text.is--duplicate {
    position: absolute;
    top: 100%;
  }

  .progress-nav__btn:hover .progress-nav__btn-text,
  .progress-nav__contact-btn:hover .progress-nav__btn-text {
    transform: translateY(-100%) rotate(0.001deg);
  }

  .progress-nav__contact-btn {
    color: #fafafa;
    background-color: #f25042;
    border-radius: 50em;
    height: 3.5em;
    padding-left: 1.5em;
    padding-right: 1.5em;
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }

  .section-resource {
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #fafafa;
  }

  .section-resource.is--flipped {
    color: #fff;
    background-color: #a6372d;
  }

  .section-resource__h2 {
    font-size: 5em;
    line-height: 1;
    font-family: "futura-100", sans-serif;
    font-weight: 700;
    font-style: normal;
    margin: 0;
    color: #f25042;
  }

  .section-resouce__h2--white {
    color: #fafafa;
  }

  .section-resource__h3 {
    font-size: 2em;
    font-family: "futura-100", sans-serif;
    font-weight: 700;
    font-style: normal;
  }

  .about-section {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5rem;
  }

  .about-section__text-container {
    /* background-color: #fafafa; */
    /* border-radius: 3rem; */
    /* border: 3px solid #000; */
    padding: 2rem;
    /* box-shadow: 0em 0.5em 0em 0em rgba(0, 0, 0, 0); */
  }

  .about-section div {
    width: 40%;
  }

  .about-section p {
    font-family: "futura-100", sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 2rem;
    color: #fafafa;
  }

  @media screen and (max-width: 890px) {
    .section-resource__h2 {
      font-size: 3em;
    }

    .section-resource__h3 {
      font-size: 1.5em;
    }

    .progress-nav__logo,
    .progress-nav__contact-btn {
      display: none;
    }

    section {
      padding: 2em 1em;
    }

    .about-section {
      flex-direction: column;
      gap: 2rem;
      margin-top: 2rem;
    }

    .about-section div {
      width: 70%;
    }

    .about-section__text-container {
      padding: 0;
      width: 90%;
    }

    .progress-nav__inner {
      justify-self: center;
    }

    h3 div {
      text-align: center !important;
    }
  }
</style>
